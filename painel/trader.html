<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel do Trader | Projeto X</title>
</head>
<body>
  <h2>Painel do Trader</h2>
  <p>Saldo total disponível para operar: <span id="saldoTotal">0</span></p>

  <h3>Encerrar Dia</h3>
  <input type="number" id="resultado" placeholder="Ex: 150 ou -80" />
  <button onclick="encerrarDia()">Finalizar Dia</button>
  <div id="msg"></div>

  <script src="../supabase.js"></script>
  <script>
    const EMAIL_TRADER = "fcmggo@gmail.com";

    async function protegerTrader() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) window.location.href = "../auth/login.html";
      if (session.user.email !== EMAIL_TRADER) window.location.href = "../painel/index.html";
    }
    protegerTrader();

    async function atualizarSaldo() {
      const { data: users } = await supabase
        .from("users")
        .select("saldo");

      let total = 0;
      users.forEach(u => total += u.saldo);
      document.getElementById("saldoTotal").innerText = total;
    }

    async function encerrarDia() {
      const valor = parseFloat(document.getElementById("resultado").value);
      const msg = document.getElementById("msg");
      if (isNaN(valor)) {
        msg.innerText = "Informe um valor válido";
        msg.style.color = "red";
        return;
      }

      const { data: sessionData } = await supabase.auth.getSession();
      const traderEmail = sessionData.session.user.email;

      await supabase.from("dias_trader").insert([{ trader_email: traderEmail, resultado: valor }]);

      let lucroTrader = 0;
      let lucroUsuario = 0;

      if (valor > 0) {
        lucroUsuario = valor * 0.7;
        lucroTrader = valor * 0.3;
      } else {
        lucroUsuario = valor;
        lucroTrader = 0;
      }

      // Atualizar trader
      await supabase.from("users").update({ saldo: supabase.raw("saldo + ?", [lucroTrader]) }).eq("email", traderEmail);
      // Atualizar todos os usuários exceto trader
      await supabase.from("users").update({ saldo: supabase.raw("saldo + ?", [lucroUsuario]) }).neq("email", traderEmail);

      msg.innerText = `Dia encerrado! Resultado: ${valor} | Lucro usuário: ${lucroUsuario} | Lucro trader: ${lucroTrader}`;
      msg.style.color = "green";

      atualizarSaldo();
    }

    atualizarSaldo();
  </script>
</body>
</html>
