<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel do Usuário</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script type="module" src="supabase.js"></script>
<style>
body { font-family: Arial,sans-serif; background:#0f172a; color:#e5e7eb; padding:20px; }
button { padding:10px 20px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer; margin-top:10px; }
button:hover { background:#1d4ed8; }
#planos p { margin:8px 0; }
</style>
</head>
<body>

<h2>Painel do Usuário</h2>
<div id="saldoLivre"></div>
<div id="saldoPlanoB"></div>
<div id="planos"></div>
<button id="ativarPlanoA">Ativar Plano A (R$20, 10 dias)</button>
<button id="iniciarPlanoB">Iniciar Plano B</button>

<script type="module">
import { supabase } from './supabase.js'

let session = JSON.parse(localStorage.getItem('session'))
if(!session){
    alert('Usuário não logado')
    window.location.href='index.html'
}

function atualizarSaldoLivre(){ document.getElementById('saldoLivre').innerText = 'Saldo livre: R$ ' + session.saldoLivre }

async function carregarPlanos(){
    const { data, error } = await supabase.from('planos').select('*').eq('user_id', session.id)
    if(error){ console.error(error); return }
    let html = '<h3>Seus Planos:</h3>'
    data.forEach(p => {
        let diasRestantes = p.fim ? Math.ceil(Math.max(0, new Date(p.fim)-new Date())/(1000*60*60*24)) : 0
        html += `<p>${p.nome} | Status: ${p.status} | Saldo: R$ ${p.saldo || 0} | Dias restantes: ${diasRestantes}</p>`
    })
    document.getElementById('planos').innerHTML = html
}

async function atualizarSaldoPlanoB(){
    const { data: planoB } = await supabase.from('planos').select('*').eq('user_id', session.id).eq('nome','Plano B').single()
    document.getElementById('saldoPlanoB').innerText = 'Saldo Plano B: R$ ' + (planoB?.saldo || 0)
}

atualizarSaldoLivre()
carregarPlanos()
atualizarSaldoPlanoB()

// Ativar Plano A
document.getElementById('ativarPlanoA').addEventListener('click', async () => {
    if(session.saldoLivre < 20){ alert('Saldo insuficiente'); return }
    const inicio = new Date()
    const fim = new Date(inicio.getTime() + 10*24*60*60*1000)
    const { data, error } = await supabase.from('planos').upsert([{ user_id: session.id, nome:'Plano A', status:'Ativo', inicio, fim }], { onConflict:['user_id','nome'] })
    if(error){ alert('Erro ao ativar Plano A'); console.error(error); return }
    session.saldoLivre -= 20
    localStorage.setItem('session', JSON.stringify(session))
    await supabase.from('users').update({ saldoLivre: session.saldoLivre }).eq('id', session.id)
    alert('Plano A ativado!')
    atualizarSaldoLivre()
    carregarPlanos()
})

// Iniciar Plano B (sem custo)
document.getElementById('iniciarPlanoB').addEventListener('click', async () => {
    const { data: planoB, error } = await supabase.from('planos').upsert([{ user_id: session.id, nome:'Plano B', status:'Ativo', saldo:0 }], { onConflict:['user_id','nome'] })
    if(error){ alert('Erro ao iniciar Plano B'); console.error(error); return }
    alert('Plano B iniciado! Deposite saldo para operações')
    atualizarSaldoPlanoB()
    carregarPlanos()
})
</script>

</body>
</html>
