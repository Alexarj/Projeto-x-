<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel do Usuário</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { background:#020617; color:#e5e7eb; font-family:Arial; padding:20px }
.box { background:#0f172a; padding:20px; border-radius:10px; max-width:500px; margin:auto }
button { padding:12px; width:100%; margin-top:10px; background:#2563eb; color:#fff; border:none; border-radius:6px }
button:disabled { background:#374151 }
</style>
</head>

<body>
<div class="box">
  <h2>Plano B – Gestão Diária</h2>

  <p>Saldo Livre: <b id="saldoLivre">--</b></p>

  <input type="number" id="valor" placeholder="Valor para entrar no Plano B">
  <button id="btnEntrar" onclick="entrarPlano()">Entrar no Plano B</button>

  <p id="status"></p>
</div>

<script type="module">
import { supabase } from './supabase.js'

const userId = localStorage.getItem("user_id")

function horaAtual() {
  return new Date().getHours()
}

async function carregar() {
  const { data: user } = await supabase
    .from('users')
    .select('saldo_livre')
    .eq('id', userId)
    .single()

  document.getElementById("saldoLivre").innerText = "R$ " + user.saldo_livre.toFixed(2)

  if (horaAtual() >= 8) {
    document.getElementById("btnEntrar").disabled = true
    document.getElementById("status").innerText = "Depósitos só até 08:00"
  }
}

async function entrarPlano() {
  const valor = Number(document.getElementById("valor").value)
  if (!valor || valor <= 0) return alert("Valor inválido")

  const { error } = await supabase.rpc("entrar_plano_b", {
    p_user_id: userId,
    p_valor: valor
  })

  if (error) return alert(error.message)

  alert("Entrada realizada com sucesso")
  carregar()
}

carregar()
</script>
</body>
</html>
