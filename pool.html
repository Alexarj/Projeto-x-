<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Trader ao Vivo - Projeto X</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; }
  header { background:#020617; padding:20px; text-align:center; font-size:24px; }
  .container { display:flex; }
  .matches { width:30%; border-right:1px solid #333; padding:10px; overflow-y:auto; height:80vh; }
  .markets { width:50%; padding:10px; overflow-y:auto; height:80vh; }
  .pool { width:20%; padding:10px; border-left:1px solid #333; }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:6px; text-align:center; border-bottom:1px solid #333; cursor:pointer; }
  th { background:#1f2937; }
  button { padding:5px 10px; margin:2px; background:#1f2937; color:#e5e7eb; border:none; cursor:pointer; }
  button:hover { background:#374151; }
  .inline-input { width:60px; text-align:center; }
</style>
</head>
<body>

<header>Projeto X - Trader ao Vivo</header>

<div class="container">

<!-- Lista de partidas -->
<div class="matches">
  <h3>Partidas</h3>
  <table id="matchesTable">
    <tr><th>Evento</th><th>Status</th></tr>
    <tr data-match="Flamengo x Palmeiras" data-live="true"><td>Flamengo x Palmeiras</td><td>Ao vivo</td></tr>
    <tr data-match="Grêmio x São Paulo" data-live="false"><td>Grêmio x São Paulo</td><td>Pré-jogo</td></tr>
  </table>
</div>

<!-- Mercados e odds -->
<div class="markets">
  <h3>Mercados</h3>
  <div id="marketsContainer">
    <p>Selecione uma partida para ver os mercados</p>
  </div>
</div>

<!-- Pool e controle -->
<div class="pool">
  <h3>Pool do Trader</h3>
  <p>Saldo disponível: <span id="poolBalance">R$1000</span></p>
  <p>Valor da aposta atual: <span id="currentBet">R$0</span></p>
  <p>Participação proporcional:</p>
  <ul id="poolUsers">
    <li>João: R$100</li>
    <li>Maria: R$150</li>
  </ul>
  <button id="closeBet">Encerrar Aposta</button>
  <hr>
  <button id="btnTransferir">Transferir para Pool</button>
  <button id="btnSaque">Retirar do Pool</button>
</div>

</div>

<script type="module">
import { transferirParaPool, saqueDoPool, setPoolOperando, atualizarPool } from './userPool.js';
import { reservarPool, encerrarAposta } from './poolSupabase.js';
import { enviarApostaPinnacle, obterOddsAoVivo } from './poolPinnacle.js';

let selectedMatch = null;
let valorAposta = 0;
let lucroAtual = 0;
let atualizando = false;

// Inicializa pool
atualizarPool();

// Lista de partidas
const matchesTable = document.getElementById("matchesTable");
const marketsContainer = document.getElementById("marketsContainer");

matchesTable.querySelectorAll("tr[data-match]").forEach(row=>{
  row.addEventListener("click", ()=>{
    selectedMatch = row.getAttribute("data-match");
    atualizarOddsAoVivo();
  });
});

// Mostra mercados
async function showMarkets(odds){
  marketsContainer.innerHTML = "";
  odds.forEach(m=>{
    const div = document.createElement("div");
    div.innerHTML = `
      <b>${m.market}</b><br>
      Back: ${m.back} <input type="number" class="inline-input" id="betBack_${m.market}" placeholder="Valor">
      <button onclick="placeBet('${m.market}','back',${m.back})">Confirmar</button>
      <br>
      Lay: ${m.lay} <input type="number" class="inline-input" id="betLay_${m.market}" placeholder="Valor">
      <button onclick="placeBet('${m.market}','lay',${m.lay})">Confirmar</button>
      <hr>
    `;
    marketsContainer.appendChild(div);
  });
}

// Apostar
window.placeBet = async function(market,type,odd){
  const inputId = type==="back"?`betBack_${market}`:`betLay_${market}`;
  valorAposta = parseFloat(document.getElementById(inputId).value);
  if(isNaN(valorAposta)||valorAposta<=0){ alert("Informe valor válido"); return; }

  const ok = await reservarPool(valorAposta);
  if(!ok) return;

  setPoolOperando(true); // bloqueia saque
  await enviarApostaPinnacle(selectedMatch, market, type, valorAposta, odd);

  lucroAtual = 0;
  atualizando = true;
  atualizarValorAoVivo();
};

// Valor ao vivo
async function atualizarValorAoVivo(){
  if(!atualizando) return;
  lucroAtual = (Math.random()-0.5)*valorAposta*0.1;
  document.getElementById("currentBet").innerText = `R$${(valorAposta+lucroAtual).toFixed(2)}`;
  setTimeout(atualizarValorAoVivo,2000);
}

// Odds ao vivo
async function atualizarOddsAoVivo(){
  if(!selectedMatch) return;
  const odds = await obterOddsAoVivo(selectedMatch);
  showMarkets(odds);
  setTimeout(atualizarOddsAoVivo,2000);
}

// Encerrar aposta
document.getElementById("closeBet").addEventListener("click", async ()=>{
  atualizando = false;
  setPoolOperando(false); // libera saque
  const valorFinal = valorAposta + lucroAtual;
  const lucro = valorFinal > valorAposta;
  await encerrarAposta(valorFinal,lucro);
  document.getElementById("currentBet").innerText = "R$0";
  alert(`Aposta encerrada com valor final: R$${valorFinal.toFixed(2)} (${lucro?"Lucro":"Perda"})`);
});

// Botão transferir para pool
document.getElementById("btnTransferir").addEventListener("click", ()=>{
  const usuario = prompt("Informe seu nome:");
  const valor = parseFloat(prompt("Informe o valor a transferir (mínimo R$20):"));
  if(isNaN(valor)) return;
  transferirParaPool(usuario, valor);
});

// Botão saque
document.getElementById("btnSaque").addEventListener("click", ()=>{
  const usuario = prompt("Informe seu nome:");
  const valor = parseFloat(prompt("Informe o valor a sacar (mínimo R$20):"));
  if(isNaN(valor)) return;
  saqueDoPool(usuario, valor);
});
</script>

</body>
  </html>
